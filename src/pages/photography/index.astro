---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
// 1. RENAME IMPORT to avoid conflict with global 'Image'
import { Image as AstroImage } from "astro:assets"; 

const photos = (await getCollection("photography")).sort(
  (a, b) => a.data.date.valueOf() - b.data.date.valueOf()
);
---

<PageLayout title="Photography" description="Visual diary">
  <Container>
    <div class="space-y-10 mb-32">
      <h1 class="animate font-semibold text-3xl md:text-4xl leading-tight text-black dark:text-white">Photography</h1>

      <div class="flex flex-col pb-40 relative"> 
        {photos.map((photo, index) => (
          
          <div 
            id={photo.slug} 
            class="animate sticky group block w-full rounded-xl shadow-xl border border-black/10 dark:border-white/10 bg-stone-100 dark:bg-stone-900 overflow-hidden"
            style={{ 
              top: `${index * 50 + 120}px`, 
              marginBottom: `${index === photos.length - 1 ? 0 : 50}px`,
              zIndex: index 
            }}
          >
             
            <div 
              class="lightbox-trigger cursor-zoom-in aspect-video w-full relative overflow-hidden"
              data-src={photo.data.cover.src}
              data-caption={photo.data.description}
            >
              <AstroImage 
                src={photo.data.cover} 
                alt={photo.data.title}
                width={1500}
                quality={90}
                class="object-cover w-full h-full transition-transform duration-700 group-hover:scale-105"
                loading={index === 0 ? "eager" : "lazy"} 
              />
              
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
              
              <div class="absolute bottom-0 left-0 p-6 md:p-8 translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500 pointer-events-none">
                <h2 class="text-white text-3xl font-bold tracking-tight">
                  {photo.data.title}
                </h2>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </Container>

  <div id="lightbox" class="fixed inset-0 z-[100] hidden bg-black/90 backdrop-blur-sm transition-opacity duration-300 opacity-0 flex items-center justify-center p-4">
    <button id="lightbox-close" class="absolute top-5 right-5 text-white/80 hover:text-white z-[110] p-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
    
    <div class="relative flex flex-col items-center justify-center max-h-[85vh] max-w-[90vw]">
      <img id="lightbox-img" src="" alt="" class="max-h-[85vh] max-w-full object-contain shadow-2xl" />
      <div id="lightbox-caption" class="absolute bottom-0 w-full bg-white/15 backdrop-blur-md text-black text-center py-2 px-4 text-sm font-medium transition-transform duration-300 translate-y-full">
      </div>
    </div>
  </div>
</PageLayout>

<script>
  // ... (keep your existing script exactly as it is)
  function setupGallery() {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img") as HTMLImageElement;
    const lightboxCaption = document.getElementById("lightbox-caption");
    const closeBtn = document.getElementById("lightbox-close");
    const triggers = document.querySelectorAll(".lightbox-trigger");

    if (!lightbox || !lightboxImg || !lightboxCaption) return;

    triggers.forEach((trigger) => {
      trigger.addEventListener("click", (e) => {
        e.preventDefault();
        const el = trigger as HTMLElement;
        const src = el.dataset.src; 
        const caption = el.dataset.caption;

        if (src) lightboxImg.src = src;
        
        if (caption) {
          lightboxCaption.textContent = caption;
          lightboxCaption.classList.remove("translate-y-full");
        } else {
          lightboxCaption.classList.add("translate-y-full");
        }

        lightbox.classList.remove("hidden");
        setTimeout(() => lightbox.classList.remove("opacity-0"), 10);
      });
    });

    const hide = () => {
      lightbox.classList.add("opacity-0");
      lightboxCaption.classList.add("translate-y-full");
      setTimeout(() => {
        lightbox.classList.add("hidden");
        lightboxImg.src = "";
      }, 300);
    };

    closeBtn?.addEventListener("click", hide);
    lightbox.addEventListener("click", (e) => {
        const target = e.target as Element;
        if (target.tagName !== "IMG" && !target.closest("#lightbox-caption")) {
             hide();
        }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") hide();
    });
  }

  document.addEventListener("astro:page-load", setupGallery);
</script>