---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import BackToPrev from "@components/BackToPrev.astro";

// 1. Generate a new path for every album you create
export async function getStaticPaths() {
  const albums = await getCollection("photography");
  return albums.map((album) => ({
    params: { slug: album.slug },
    props: { album },
  }));
}

const { album } = Astro.props;
const { Content } = await album.render();
---

<PageLayout title={album.data.title} description={album.data.description || "Photo Album"}>
  <Container>
    <div class="animate">
      <BackToPrev href="/index">Back to Home</BackToPrev>
    </div>

    <div class="space-y-1 my-10">
      <h1 class="animate font-semibold text-3xl text-black dark:text-white">
        {album.data.title}
      </h1>
    </div>

    <article class="animate space-y-8 photo-gallery">
      <Content />
    </article>
  </Container>

  <div id="lightbox" class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-sm transition-opacity duration-300 opacity-0">
    
    <button id="lightbox-close" class="absolute top-5 right-5 text-white/80 hover:text-white z-50 p-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>

    <div class="w-full h-full flex items-center justify-center p-4 relative">
      <img id="lightbox-img" src="" alt="" class="max-h-full max-w-full object-contain shadow-2xl" />
      
      <div id="lightbox-caption" class="absolute bottom-0 left-0 w-full bg-white/70 backdrop-blur-md text-black text-center py-4 px-6 text-lg font-medium translate-y-full transition-transform duration-300">
        </div>
    </div>
  </div>
</PageLayout>

<script>
  function setupLightbox() {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img") as HTMLImageElement;
    const lightboxCaption = document.getElementById("lightbox-caption");
    const closeBtn = document.getElementById("close-lightbox");
    
    // If these elements don't exist, stop the script immediately
    if (!lightbox || !lightboxImg || !lightboxCaption) return;

    const images = document.querySelectorAll(".photo-gallery img");

    images.forEach(img => {
      (img as HTMLElement).style.cursor = "zoom-in";
      
      img.addEventListener("click", (e) => {
        e.preventDefault();
        const el = img as HTMLImageElement;
        
        lightboxImg.src = el.src;
        
        if (el.alt) {
            lightboxCaption.textContent = el.alt;
            lightboxCaption.classList.remove("opacity-0", "translate-y-2");
        } else {
            lightboxCaption.classList.add("opacity-0", "translate-y-2");
        }
        
        lightbox.classList.remove("hidden");
      });
    });

    const hide = () => {
        lightbox.classList.add("hidden");
        lightboxImg.src = "";
    };

    closeBtn?.addEventListener("click", hide);

    lightbox.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      // We check if the user clicked the background or the relative container
      if (target === lightbox || target.closest(".relative")) {
        hide();
      }
    });
    
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") hide();
    });
  }

  document.addEventListener("astro:page-load", setupLightbox);
</script>